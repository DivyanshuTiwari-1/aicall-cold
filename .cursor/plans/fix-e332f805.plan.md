<!-- e332f805-94e5-4c3f-bb37-edbe993ffce9 382f83c0-9b07-4a39-a974-f0071ea77f74 -->
# Fix Manual and Automated Calling Issues

## Root Cause Analysis

**Manual Calls Failure:**

- Error: "Allocation failed" from Asterisk ARI
- Problem: Code tries to call `PJSIP/agent_{agentUserId}` (e.g., `PJSIP/agent_e64a3175-c8b1-4165-b482-bee5422bdeb4`)
- Reality: PJSIP endpoint is configured as `agent_e64a3175-c8b1-4165-b482-bee5422bdeb4` (without `PJSIP/` prefix being correct)
- Location: `server/services/telephony/providers/asterisk.js:63`

**Automated Calls Failure:**

- Same "Allocation failed" error indicates Telnyx endpoint configuration issue
- Problem: Trying to dial `PJSIP/${toPhone}@telnyx_endpoint` but the endpoint doesn't exist in PJSIP config
- The PJSIP config only has `telnyx_endpoint`, `local_endpoint`, and dynamic agent endpoints
- Location: `server/services/telephony/providers/asterisk.js:27`

## Key Issues Identified

### Issue 1: Agent Endpoint Mismatch

File: `server/services/telephony/providers/asterisk.js:63`

```javascript
endpoint: `PJSIP/agent_${agentUserId}`,
```

Should match the PJSIP dynamic config which creates endpoints named exactly `agent_{USER_ID}`

### Issue 2: Missing Telnyx Outbound Endpoint

File: `asterisk-config/pjsip.conf:32-55`

- The config defines `telnyx_endpoint` but it's configured for **inbound** only
- For outbound, we need proper authentication and registration
- Currently missing proper outbound configuration

### Issue 3: Asterisk Unhealthy Status

- Docker shows: `asterisk` container is `(unhealthy)`
- This could be causing PJSIP to not load configurations properly
- Need to verify Asterisk is actually running and PJSIP modules are loaded

## Implementation Plan

### Step 1: Verify and Fix Asterisk Health

- Check if Asterisk is actually running inside the container
- Verify PJSIP modules are loaded (`module show like pjsip`)
- Check if configurations are being read properly
- Fix any configuration syntax errors

### Step 2: Fix Telnyx Outbound Configuration

File: `asterisk-config/pjsip.conf`

- Add proper outbound endpoint configuration for Telnyx
- Ensure authentication is working
- Add proper AOR with registration if needed
- Test basic outbound connectivity

### Step 3: Verify Agent Endpoint Registration

- Confirm agent endpoints are properly loaded from `pjsip_dynamic.conf`
- Check if the `#include pjsip_dynamic.conf` directive is working
- Reload PJSIP configuration after changes

### Step 4: Fix Manual Call Endpoint Reference

File: `server/services/telephony/providers/asterisk.js:63`

- Current code already updated to use `agentUserId`
- Verify the endpoint name matches PJSIP config exactly
- May need to reload server to pick up changes

### Step 5: Add Proper Error Handling

- Add better logging for ARI originate failures
- Include actual endpoint being called in error messages
- Log available endpoints for debugging

## Files to Modify

1. `asterisk-config/pjsip.conf` - Fix Telnyx outbound configuration
2. `server/services/telephony/providers/asterisk.js` - Already modified, may need verification
3. Asterisk container - Health check and module verification

## Success Criteria

- Asterisk container shows `(healthy)` status
- `pjsip show endpoints` shows all expected endpoints
- Manual calls successfully originate to agent endpoint
- Automated calls successfully originate through Telnyx
- No "Allocation failed" errors in logs