[globals]
; AI Dialer Configuration
AI_DIALER_APP=ai-dialer
AI_DIALER_URL=http://host.docker.internal:3000/api/v1/asterisk
TTS_ENGINE=espeak
TTS_LANGUAGE=en-US
TTS_VOICE=en-us
TELNYX_TIMEOUT=30
MAX_CALL_DURATION=180

; Call flow states
CALL_STATE_GREETING=greeting
CALL_STATE_SCRIPT=script
CALL_STATE_RESPONSE=response
CALL_STATE_FOLLOWUP=followup
CALL_STATE_TRANSFER=transfer
CALL_STATE_HANGUP=hangup

[ai-dialer]
; Main context for AI dialer calls
exten => _X.,1,NoOp(AI Dialer: Starting call to ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(CONTACT_PHONE=${EXTEN})
 same => n,Set(CAMPAIGN_ID=${ARG2})
 same => n,Set(CALL_START_TIME=${EPOCH})
 same => n,Set(CALL_STATE=${CALL_STATE_GREETING})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(CALLER_ID=${CALLERID(num)})
 same => n,Set(UNIQUE_ID=${UNIQUEID})
 same => n,AGI(ai-dialer-agi.php,${CALL_ID},${CONTACT_PHONE},${CAMPAIGN_ID})
 same => n,Hangup()

; Handle incoming calls (for testing)
exten => 100,1,NoOp(Test extension for AI dialer)
 same => n,Answer()
 same => n,Playback(hello-world)
 same => n,Hangup()

; Emergency hangup
exten => h,1,NoOp(AI Dialer: Call ended)
 same => n,AGI(ai-dialer-hangup-agi.php,${CALL_ID},${CALL_STATE})

[ai-dialer-outbound]
; Outbound call context with Telnyx integration
exten => _X.,1,NoOp(AI Dialer Outbound: Calling ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(CONTACT_PHONE=${EXTEN})
 same => n,Set(CAMPAIGN_ID=${ARG2})
 same => n,Set(CALL_START_TIME=${EPOCH})
 same => n,Set(CALL_STATE=${CALL_STATE_GREETING})
 same => n,Set(CALLER_ID=${CALLERID(num)})
 same => n,Set(UNIQUE_ID=${UNIQUEID})
 same => n,Set(TELNYX_TIMEOUT=${TELNYX_TIMEOUT})
 same => n,Dial(PJSIP/${EXTEN}@telnyx_endpoint,${TELNYX_TIMEOUT},g)
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?answered:notanswered)
 same => n(answered),Set(CALL_STATE=${CALL_STATE_SCRIPT})
 same => n,AGI(ai-dialer-agi.php,${CALL_ID},${CONTACT_PHONE},${CAMPAIGN_ID})
 same => n,Hangup()
 same => n(notanswered),Set(CALL_STATE=no_answer)
 same => n,AGI(ai-dialer-hangup-agi.php,${CALL_ID},${CALL_STATE})
 same => n,Hangup()

; Handle call progress
exten => g,1,NoOp(AI Dialer: Call answered)
 same => n,Set(CALL_STATE=${CALL_STATE_SCRIPT})
 same => n,Return()

[ai-dialer-tts]
; TTS playback context with multiple engines
exten => _X.,1,NoOp(TTS Playback: ${EXTEN})
 same => n,Set(TTS_TEXT=${ARG1})
 same => n,Set(TTS_VOICE=${ARG2})
 same => n,Set(TTS_SPEED=${ARG3})
 same => n,Set(TTS_FILE=/tmp/tts_${UNIQUEID}_${EPOCH}.wav)
 same => n,GotoIf($["${TTS_ENGINE}" = "espeak"]?espeak_tts:fallback_tts)
 same => n(espeak_tts),System(espeak -s ${TTS_SPEED:-150} -v ${TTS_VOICE:-en-us} "${TTS_TEXT}" -w ${TTS_FILE})
 same => n,GotoIf($["${SYSTEMSTATUS}" = "SUCCESS"]?play_tts:fallback_tts)
 same => n(play_tts),Playback(${TTS_FILE})
 same => n,System(rm -f ${TTS_FILE})
 same => n,Return()
 same => n(fallback_tts),Playback(ai-dialer/tts-error)
 same => n,Return()

[ai-dialer-inbound]
; Inbound call context for Telnyx
exten => _X.,1,NoOp(AI Dialer Inbound: ${EXTEN})

[manual-dialer-bridge]
; Manual call bridge context for agent-customer calls
exten => _X.,1,NoOp(Manual Call Bridge: ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(CONTACT_ID=${ARG2})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Stasis(manual-dialer-bridge,${CALL_ID},${CONTACT_ID})
 same => n,Hangup()

; Emergency hangup for manual calls
exten => h,1,NoOp(Manual Call Bridge: Call ended)
 same => n,AGI(ai-dialer-hangup-agi.php,${CALL_ID},manual_completed)

; Stasis Applications for ARI
[ai-dialer-stasis]
exten => s,1,NoOp(AI Dialer Stasis App - Call ID: ${ARG1}, Phone: ${ARG2}, Campaign: ${ARG3})
 same => n,AGI(ai-dialer-agi.php,${ARG1},${ARG2},${ARG3})
 same => n,Hangup()

[manual-dialer-bridge-stasis]
exten => s,1,NoOp(Manual Dialer Bridge Stasis App - Call ID: ${ARG1}, Contact ID: ${ARG2})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(beep)
 same => n,Hangup()
