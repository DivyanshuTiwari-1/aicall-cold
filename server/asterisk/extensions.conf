[globals]
; AI Dialer Configuration
AI_DIALER_APP=ai-dialer
AI_DIALER_URL=http://localhost:3000/api/v1/asterisk
TTS_ENGINE=google
TTS_LANGUAGE=en-US
TTS_VOICE=en-US-Wavenet-D
TELNYX_TIMEOUT=30
MAX_CALL_DURATION=300

; Call flow states
CALL_STATE_GREETING=greeting
CALL_STATE_SCRIPT=script
CALL_STATE_RESPONSE=response
CALL_STATE_FOLLOWUP=followup
CALL_STATE_TRANSFER=transfer
CALL_STATE_HANGUP=hangup

[ai-dialer]
; Main context for AI dialer calls
exten => _X.,1,NoOp(AI Dialer: Starting call to ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(CONTACT_PHONE=${EXTEN})
 same => n,Set(CAMPAIGN_ID=${ARG2})
 same => n,Set(CALL_START_TIME=${EPOCH})
 same => n,Set(CALL_STATE=${CALL_STATE_GREETING})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(CALLER_ID=${CALLERID(num)})
 same => n,Set(UNIQUE_ID=${UNIQUEID})
 same => n,AGI(ai-dialer-agi.php,${CALL_ID},${CONTACT_PHONE},${CAMPAIGN_ID})
 same => n,Hangup()

; Handle incoming calls (for testing)
exten => 100,1,NoOp(Test extension for AI dialer)
 same => n,Answer()
 same => n,Playback(hello-world)
 same => n,Hangup()

; Emergency hangup
exten => h,1,NoOp(AI Dialer: Call ended)
 same => n,AGI(ai-dialer-hangup-agi.php,${CALL_ID},${CALL_STATE})

[ai-dialer-outbound]
; Outbound call context with Telnyx integration
exten => _X.,1,NoOp(AI Dialer Outbound: Calling ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(CONTACT_PHONE=${EXTEN})
 same => n,Set(CAMPAIGN_ID=${ARG2})
 same => n,Set(CALL_START_TIME=${EPOCH})
 same => n,Set(CALL_STATE=${CALL_STATE_GREETING})
 same => n,Set(CALLER_ID=${CALLERID(num)})
 same => n,Set(UNIQUE_ID=${UNIQUEID})
 same => n,Set(TELNYX_TIMEOUT=${TELNYX_TIMEOUT})
 same => n,Dial(PJSIP/${EXTEN}@telnyx_endpoint,${TELNYX_TIMEOUT},g)
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?answered:notanswered)
 same => n(answered),Set(CALL_STATE=${CALL_STATE_SCRIPT})
 same => n,AGI(ai-dialer-agi.php,${CALL_ID},${CONTACT_PHONE},${CAMPAIGN_ID})
 same => n,Hangup()
 same => n(notanswered),Set(CALL_STATE=no_answer)
 same => n,AGI(ai-dialer-hangup-agi.php,${CALL_ID},${CALL_STATE})
 same => n,Hangup()

; Handle call progress
exten => g,1,NoOp(AI Dialer: Call answered)
 same => n,Set(CALL_STATE=${CALL_STATE_SCRIPT})
 same => n,Return()

[ai-dialer-tts]
; TTS playback context with multiple engines
exten => _X.,1,NoOp(TTS Playback: ${EXTEN})
 same => n,Set(TTS_TEXT=${ARG1})
 same => n,Set(TTS_VOICE=${ARG2})
 same => n,Set(TTS_SPEED=${ARG3})
 same => n,Set(TTS_FILE=/tmp/tts_${UNIQUEID}_${EPOCH}.wav)
 same => n,GotoIf($["${TTS_ENGINE}" = "google"]?google_tts:espeak_tts)
 same => n(google_tts),AGI(ai-tts-google-agi.php,${TTS_TEXT},${TTS_VOICE},${TTS_FILE})
 same => n,GotoIf($["${AGISTATUS}" = "SUCCESS"]?play_tts:fallback_tts)
 same => n(espeak_tts),System(espeak -s ${TTS_SPEED:-150} -v ${TTS_VOICE:-en-us} "${TTS_TEXT}" -w ${TTS_FILE})
 same => n,GotoIf($["${SYSTEMSTATUS}" = "SUCCESS"]?play_tts:fallback_tts)
 same => n(play_tts),Playback(${TTS_FILE})
 same => n,System(rm -f ${TTS_FILE})
 same => n,Return()
 same => n(fallback_tts),Playback(ai-dialer/tts-error)
 same => n,Return()

[ai-dialer-conversation]
; Conversation handling context with state management
exten => _X.,1,NoOp(Conversation: ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(USER_INPUT=${ARG2})
 same => n,Set(CONVERSATION_STATE=${ARG3})
 same => n,Set(SCRIPT_INDEX=${ARG4})
 same => n,AGI(ai-conversation-agi.php,${CALL_ID},${USER_INPUT},${CONVERSATION_STATE},${SCRIPT_INDEX})
 same => n,Return()

[ai-dialer-response]
; Response handling context
exten => _X.,1,NoOp(Response Handler: ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(RESPONSE_TYPE=${ARG2})
 same => n,Set(USER_AUDIO=${ARG3})
 same => n,AGI(ai-response-agi.php,${CALL_ID},${RESPONSE_TYPE},${USER_AUDIO})
 same => n,Return()

[ai-dialer-transfer]
; Transfer handling context
exten => _X.,1,NoOp(Transfer Handler: ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(TRANSFER_TYPE=${ARG2})
 same => n,Set(TRANSFER_NUMBER=${ARG3})
 same => n,AGI(ai-transfer-agi.php,${CALL_ID},${TRANSFER_TYPE},${TRANSFER_NUMBER})
 same => n,Return()

[ai-dialer-followup]
; Follow-up conversation context
exten => _X.,1,NoOp(Follow-up: ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(FOLLOWUP_SCRIPT=${ARG2})
 same => n,Set(USER_RESPONSE=${ARG3})
 same => n,AGI(ai-followup-agi.php,${CALL_ID},${FOLLOWUP_SCRIPT},${USER_RESPONSE})
 same => n,Return()

[ai-dialer-voicemail]
; Voicemail handling context
exten => _X.,1,NoOp(Voicemail: ${EXTEN})
 same => n,Set(CALL_ID=${ARG1})
 same => n,Set(VOICEMAIL_MESSAGE=${ARG2})
 same => n,Playback(ai-dialer/voicemail-intro)
 same => n,AGI(ai-tts-google-agi.php,${VOICEMAIL_MESSAGE},en-US-Wavenet-D,/tmp/vm_${UNIQUEID}.wav)
 same => n,Playback(/tmp/vm_${UNIQUEID}.wav)
 same => n,Record(custom/voicemail_${CALL_ID}_${EPOCH}:wav,60,beep)
 same => n,System(rm -f /tmp/vm_${UNIQUEID}.wav)
 same => n,AGI(ai-voicemail-agi.php,${CALL_ID},voicemail_${CALL_ID}_${EPOCH}.wav)
 same => n,Hangup()

[ai-dialer-test]
; Testing context for development
exten => _X.,1,NoOp(AI Dialer Test: ${EXTEN})
 same => n,Answer()
 same => n,Playback(ai-dialer/test-intro)
 same => n,AGI(ai-tts-google-agi.php,"Hello, this is a test of the AI dialer system. How are you today?",en-US-Wavenet-D,/tmp/test_${UNIQUEID}.wav)
 same => n,Playback(/tmp/test_${UNIQUEID}.wav)
 same => n,WaitForSilence(2000,5000)
 same => n,Record(custom/test_response_${UNIQUEID}:wav,10,beep)
 same => n,Playback(ai-dialer/test-outro)
 same => n,System(rm -f /tmp/test_${UNIQUEID}.wav)
 same => n,Hangup()

; Include other contexts
include => ai-dialer-scripts
include => ai-dialer-errors
include => ai-dialer-utils
include => ai-dialer-inbound

[ai-dialer-inbound]
; Inbound call context for Telnyx
exten => _X.,1,NoOp(AI Dialer Inbound: ${EXTEN})
 same => n,Set(CALLER_ID=${CALLERID(num)})
 same => n,Set(CALLER_NAME=${CALLERID(name)})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(ai-dialer/inbound-greeting)
 same => n,AGI(ai-inbound-agi.php,${CALLER_ID},${CALLER_NAME})
 same => n,Hangup()

; Include other contexts
include => ai-dialer-scripts
include => ai-dialer-errors
include => ai-dialer-utils

[ai-dialer-scripts]
; Script management context
exten => _X.,1,NoOp(Script Manager: ${EXTEN})
 same => n,Set(SCRIPT_ID=${ARG1})
 same => n,Set(SCRIPT_TYPE=${ARG2})
 same => n,Set(CALL_ID=${ARG3})
 same => n,AGI(ai-script-agi.php,${SCRIPT_ID},${SCRIPT_TYPE},${CALL_ID})
 same => n,Return()

[ai-dialer-errors]
; Error handling context
exten => _X.,1,NoOp(Error Handler: ${EXTEN})
 same => n,Set(ERROR_CODE=${ARG1})
 same => n,Set(CALL_ID=${ARG2})
 same => n,AGI(ai-error-agi.php,${ERROR_CODE},${CALL_ID})
 same => n,Return()

[ai-dialer-utils]
; Utility functions context
exten => _X.,1,NoOp(Utils: ${EXTEN})
 same => n,Set(UTIL_FUNCTION=${ARG1})
 same => n,Set(UTIL_PARAMS=${ARG2})
 same => n,AGI(ai-utils-agi.php,${UTIL_FUNCTION},${UTIL_PARAMS})
 same => n,Return()
